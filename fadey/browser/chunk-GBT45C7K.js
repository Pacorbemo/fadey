import{a as Q}from"./chunk-HM5LNHNT.js";import{d as P}from"./chunk-7WZSBKTQ.js";import{b as G,e as K}from"./chunk-Q45SLHZI.js";import{$a as y,A as V,Ga as m,Gb as J,H as A,Hb as Y,I as g,Ka as x,Pa as H,Sa as z,U as b,Ua as D,Z as S,ab as U,cb as w,db as M,ec as q,fa as _,fb as O,ga as v,gb as j,hb as n,ib as o,l as F,lb as T,mb as C,nb as p,t as f,u as B,vb as d,wb as $,xb as k,yb as L,zb as N}from"./chunk-EP4M2S5W.js";var W=(()=>{class i{transform(e){let t=e.toLocaleString("default",{month:"long"});return t.charAt(0).toUpperCase()+t.slice(1)}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275pipe=z({name:"dateMesString",type:i,pure:!0})}}return i})();var R=(()=>{class i{constructor(){this._cargandoSubject=new F(!1),this.cargando$=this._cargandoSubject.asObservable(),this._inicioTiempo=0,this.cargandoProlongado=B([this.cargando$,V(100)]).pipe(f(([e,t])=>e?Date.now()-this._inicioTiempo>500:!1),A())}set cargando(e){e&&!this._cargandoSubject.value&&(this._inicioTiempo=Date.now()),this._cargandoSubject.next(e)}ocultarCargando(){this._cargandoSubject.next(!1)}get cargando(){return this._cargandoSubject.value}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=b({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var X=(()=>{class i{constructor(e,t){this.httpService=e,this.cargandoService=t}dateAUTC(e){return new Date(e.getTime()+e.getTimezoneOffset()*60*1e3)}primerDiaSemana(e){let t=new Date(e),a=t.getDay(),r=a===0?-6:1-a;return t.setDate(t.getDate()+r),t}diaHora(e,t){let[a,r]=t.split(":").map(Number),c=new Date(e);return c.setHours(a,r,0,0),c}calcularSemana(e,t=0){let a=[];e.setUTCHours(0,0,0,0);let r=this.primerDiaSemana(this.sumarDias(e,t*7));for(let c=0;c<7;c++)a.push(this.sumarDias(r,c));return a}sumarDias(e,t){let a=new Date(e);return a.setDate(a.getDate()+t),a}generarFranjasHorarias(e){let t,a,r;if(e){let s=Object.values(e).flat();t=Math.min(...s.map(h=>parseInt(h.split(":")[0]))),a=Math.max(...s.map(h=>parseInt(h.split(":")[0]))),r=Math.max(...s.filter(h=>parseInt(h.split(":")[0])===a).map(h=>parseInt(h.split(":")[1])))}else t=0,a=23,r=30;let l=[];for(let s=t;s<a+1;s++)for(let h=0;h<60;h+=30){let ee=`${s.toString().padStart(2,"0")}:${h.toString().padStart(2,"0")}`;if(l.push(ee),s===a&&h===r)break}return l}subirCitas(e,t){let a={idBarbero:e,fechas:t};return this.httpService.postToken("/citas/crear",a)}getCitas(e,t){t=this.primerDiaSemana(t);let a=this.sumarDias(t,7),r={idBarbero:e,inicio:t,fin:a};return this.httpService.postToken("/citas",r).pipe(f(c=>["totales","reservadas","reservadasUsuario"].reduce((l,s)=>(l[s]=this.procesarFechas(c[s]),l),{})),g(()=>{this.cargandoService.ocultarCargando()}))}getCitasBarbero(e={}){return this.httpService.getToken("/citas/barbero",e)}getCitasUsuario(e={}){return this.httpService.getToken("/citas/cliente",e)}purgarDiasPasados(e,t){let a=new Date,r={};return Object.entries(e).forEach(([c,l])=>{let s=parseInt(c);s===a.getDate()?r[s]=l.filter(h=>h>`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`):(s>a.getDate()||s<a.getDate()-7)&&(r[s]=l)}),r}procesarFechas(e){let t={};return e.forEach(a=>{let r=new Date(a),c=r.getDate();t[c]||(t[c]=[]),t[c].push(`${r.getHours().toString().padStart(2,"0")}:${r.getMinutes().toString().padStart(2,"0")}`)}),t}confirmarReserva(e,t){let a={idBarbero:e,dia:t};return this.httpService.postToken("/citas/confirmar",a)}generarCitasSemana(e,t){return this.httpService.postToken("/citas/generar-semana",{inicio:e,fin:t})}static{this.\u0275fac=function(t){return new(t||i)(S(P),S(R))}}static{this.\u0275prov=b({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Z=(()=>{class i{constructor(e,t){this.httpService=e,this.cargandoService=t}getRelaciones(e){return this.httpService.getToken("/relaciones").pipe(f(t=>(e&&(t=JSON.parse(JSON.stringify(t)).filter(a=>a.estado===e)),t)),g(()=>this.cargandoService.ocultarCargando()))}getRelacionesCliente(){return this.httpService.getToken("/relaciones/cliente").pipe(f(e=>JSON.parse(JSON.stringify(e)).filter(t=>t.estado==="aceptado")),g(()=>this.cargandoService.ocultarCargando()))}getRelacionesBarbero(){return this.httpService.getToken("/relaciones/barbero").pipe(f(e=>JSON.parse(JSON.stringify(e)).filter(t=>t.estado==="aceptado")),g(()=>this.cargandoService.ocultarCargando()))}getSolicitudes(){return this.httpService.getToken("/relaciones/solicitudes").pipe(g(()=>this.cargandoService.ocultarCargando()))}solicitar(e){return this.httpService.postToken("/relaciones/solicitar",{userBarbero:e}).pipe(f(t=>!!t),g(()=>this.cargandoService.ocultarCargando()))}aceptarSolicitud(e){return this.httpService.postToken("/relaciones/aceptar",{idRelacion:e}).pipe(g(()=>this.cargandoService.ocultarCargando()))}rechazarSolicitud(e){return this.httpService.postToken("/relaciones/rechazar",{idRelacion:e}).pipe(g(()=>this.cargandoService.ocultarCargando()))}eliminarRelacion(e){return this.httpService.postToken("/relaciones/eliminar",{idRelacion:e}).pipe(g(()=>this.cargandoService.ocultarCargando()))}comprobarRelacion(e){return this.httpService.getToken("/relaciones/comprobar",{idBarbero:e.toString()}).pipe(g(()=>this.cargandoService.ocultarCargando()))}static{this.\u0275fac=function(t){return new(t||i)(S(P),S(R))}}static{this.\u0275prov=b({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();function re(i,u){if(i&1&&(n(0,"div",1)(1,"div",2)(2,"p"),d(3),o(),n(4,"a",3),d(5,"Volver a Inicio"),o()()()),i&2){let e=p();m(3),k('El usuario "',e.usernameBarbero,'" no es v\xE1lido')}}function ne(i,u){if(i&1&&(n(0,"div",1)(1,"div",2)(2,"p"),d(3),o(),n(4,"a",3),d(5,"Volver a Inicio"),o()()()),i&2){let e=p();m(3),k('El usuario "',e.usernameBarbero,'" no es Barbero')}}function oe(i,u){if(i&1){let e=T();n(0,"button",4),C("click",function(){_(e);let a=p(2);return v(a.solicitar(a.usernameBarbero))}),d(1,"Enviar solicitud"),o()}}function se(i,u){i&1&&(n(0,"h3"),d(1,"Ya has enviado una solicitud, espera a que sea aceptada"),o())}function ce(i,u){i&1&&(n(0,"h3"),d(1,"Tu solicitud ha sido rechazada"),o())}function le(i,u){if(i&1&&(n(0,"div",1)(1,"div",2)(2,"p"),d(3),o(),D(4,oe,2,0,"button")(5,se,2,0,"h3")(6,ce,2,0,"h3"),n(7,"a",3),d(8,"Volver a Inicio"),o()()()),i&2){let e=p();m(3),k("No tienes acceso a las citas de ",e.usernameBarbero,""),m(),w(e.relacion=="ninguna"?4:e.relacion=="pendiente"?5:e.relacion=="rechazado"?6:-1)}}function de(i,u){if(i&1&&(n(0,"th"),d(1),o()),i&2){let e=u.$implicit;m(),$(e.getDate())}}function me(i,u){if(i&1){let e=T();n(0,"td")(1,"button",6),C("click",function(){let a=_(e).$implicit,r=p().$implicit,c=p(3);return v(c.mostrarReserva(a,r))}),d(2),o()()}if(i&2){let e=u.$implicit,t=p().$implicit,a=p(3);m(),U("selected",a.esFranjaReservada(e.getDate(),t)===1)("reservada",a.esFranjaReservada(e.getDate(),t)===2),y("disabled",!a.esFranjaDisponible(e,t)||a.esFranjaReservada(e.getDate(),t)),m(),k(" ",t," ")}}function pe(i,u){if(i&1&&(n(0,"tr"),O(1,me,3,6,"td",null,M),o()),i&2){let e=p(3);m(),j(e.diasDeLaSemana)}}function ue(i,u){if(i&1&&(n(0,"tbody"),O(1,pe,3,0,"tr",null,M),o()),i&2){let e=p(2);m(),j(e.franjasHorarias)}}function he(i,u){i&1&&(n(0,"tr")(1,"td",7),d(2,"No hay horarios disponibles esta semana"),o()())}function ge(i,u){if(i&1){let e=T();n(0,"p"),d(1),o(),n(2,"button",4),C("click",function(){_(e);let a=p(3);return v(a.confirmarReserva())}),d(3,"Confirmar"),o()}if(i&2){let e=p(3);m(),N("Reservar el ",e.diaSeleccionado.getDate()," a las ",e.diaSeleccionado.getHours(),":",e.diaSeleccionado.getMinutes()===0?"00":e.diaSeleccionado.getMinutes(),"")}}function fe(i,u){i&1&&(n(0,"p"),d(1,"No puedes reservarte cita a ti mismo"),o())}function _e(i,u){if(i&1){let e=T();n(0,"div",1)(1,"div",2),D(2,ge,4,3)(3,fe,2,0,"p"),n(4,"button",4),C("click",function(){_(e);let a=p(2);return v(a.cancelarReserva())}),d(5,"Cancelar"),o()()()}if(i&2){let e=p(2);m(2),w(e.idBarbero!=e.idUsuario?2:3)}}function ve(i,u){if(i&1){let e=T();n(0,"h2"),d(1),J(2,"dateMesString"),o(),n(3,"div",5)(4,"button",6),C("click",function(){_(e);let a=p();return v(a.cambiarSemana(-1))}),d(5,"-"),o(),n(6,"button",4),C("click",function(){_(e);let a=p();return v(a.cambiarSemana(1))}),d(7,"+"),o()(),n(8,"table")(9,"thead")(10,"tr"),O(11,de,2,1,"th",null,M),o()(),D(13,ue,3,0,"tbody")(14,he,3,0,"tr"),o(),D(15,_e,6,1,"div",1)}if(i&2){let e=p();m(),L("",Y(2,5,e.semanaActual.fin)," ",e.semanaActual.fin.getFullYear(),""),m(3),y("disabled",e.desactivarAtras()),m(7),j(e.diasDeLaSemana),m(2),w(e.franjasHorarias.length>0?13:14),m(2),w(e.mostrarDialogo?15:-1)}}var Oe=(()=>{class i{constructor(e,t,a,r,c){this.citasService=e,this.usuariosService=t,this.relacionesService=a,this.route=r,this.cargandoService=c,this.usernameValido=!1,this.usuarioAutorizado=!1,this.relacion="",this.diasDeLaSemana=[],this.franjasHorarias=[],this.idUsuario=parseInt(JSON.parse(localStorage.getItem("user")||"{}").id||"0",10),this.idBarbero=0,this.usernameBarbero="",this.esBarbero=!0,this.horariosDisponibles=[],this.horariosReservados=[],this.horariosReservadosPorUsuario=[],this.mostrarDialogo=!1,this.diaSeleccionado=new Date,this.semanaActual={inicio:new Date,fin:new Date}}ngOnInit(){this.route.params.subscribe({next:e=>{this.usernameBarbero=e.username,this.usuariosService.datosUsername(this.usernameBarbero).subscribe({next:t=>{this.usernameValido=t.exists,t.exists&&t.user?.id&&(this.idBarbero=t.user?.id),this.usernameValido&&(this.idBarbero==this.idUsuario?(this.usuarioAutorizado=!0,this.esBarbero=!0,this.calcularSemana(),this.relacion="aceptado"):this.relacionesService.comprobarRelacion(this.idBarbero).subscribe({next:a=>{this.usuarioAutorizado=a.relacion=="aceptado",this.relacion=a.relacion,this.usuariosService.esBarbero(this.idBarbero).subscribe({next:r=>{this.esBarbero=r,this.usuarioAutorizado&&this.esBarbero&&this.calcularSemana()}})}}))}})}})}desactivarAtras(){return this.semanaActual.inicio.getTime()<=this.citasService.dateAUTC(new Date).getTime()}calcularSemana(e=0){this.diasDeLaSemana=this.citasService.calcularSemana(this.semanaActual.inicio,e),this.semanaActual.inicio=this.diasDeLaSemana[0],this.semanaActual.fin=this.diasDeLaSemana[6],this.recargarCitas()}cambiarSemana(e){this.calcularSemana(e)}getStringMes(e){return new Date(2025,e-1).toLocaleString("default",{month:"long"})}recargarCitas(){this.citasService.getCitas(this.idBarbero,this.semanaActual.inicio).subscribe({next:e=>{this.horariosReservados=e.reservadas,this.horariosDisponibles=this.citasService.purgarDiasPasados(e.totales,this.semanaActual.inicio),this.horariosReservadosPorUsuario=e.reservadasUsuario,this.generarFranjasHorarias()}})}generarFranjasHorarias(){let e=Object.values(this.horariosDisponibles).flat(),t=Math.min(...e.map(l=>parseInt(l.split(":")[0]))),a=Math.max(...e.map(l=>parseInt(l.split(":")[0]))),r=Math.max(...e.filter(l=>parseInt(l.split(":")[0])===a).map(l=>parseInt(l.split(":")[1]))),c=30;this.franjasHorarias=[];for(let l=t;l<a+1;l++)for(let s=0;s<60;s+=c){let h=`${l.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;if(this.franjasHorarias.push(h),l===a&&s===r)break}}esFranjaDisponible(e,t){return this.citasService.diaHora(e,t).getTime()<new Date().getTime()?!1:this.horariosDisponibles[e.getDate()]?.includes(t)||!1}esFranjaReservada(e,t){return this.horariosReservadosPorUsuario[e]?.includes(t)?2:this.horariosReservados[e]?.includes(t)?1:0}mostrarReserva(e,t){this.diaSeleccionado=this.citasService.diaHora(e,t),this.mostrarDialogo=!0}confirmarReserva(){this.citasService.confirmarReserva(this.idBarbero,this.diaSeleccionado).subscribe({next:()=>{this.mostrarDialogo=!1,this.recargarCitas()},error:e=>{console.error("Error al confirmar la reserva:",e)}})}cancelarReserva(){this.mostrarDialogo=!1}solicitar(e){this.relacionesService.solicitar(e),this.relacion="pendiente"}static{this.\u0275fac=function(t){return new(t||i)(x(X),x(Q),x(Z),x(G),x(R))}}static{this.\u0275cmp=H({type:i,selectors:[["app-reservar-citas"]],decls:5,vars:1,consts:[[1,"component-container"],[1,"overlay"],[1,"reserva-dialogo"],["routerLink","/"],[3,"click"],[1,"botones-cambio-semana"],[3,"click","disabled"],["colspan","7"]],template:function(t,a){t&1&&(n(0,"div",0),D(1,re,6,1,"div",1)(2,ne,6,1,"div",1)(3,le,9,2,"div",1)(4,ve,16,7),o()),t&2&&(m(),w(a.usernameValido?a.esBarbero?a.usuarioAutorizado?a.usernameValido?4:-1:3:2:1))},dependencies:[W,q,K],styles:["h2[_ngcontent-%COMP%]{font-size:2vw}table[_ngcontent-%COMP%]{width:50vw;border-collapse:collapse;text-align:center;table-layout:fixed}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:10px;border:1px solid #ddd}button[_ngcontent-%COMP%]{width:100%;padding:5px;border:none;cursor:pointer}button.selected[_ngcontent-%COMP%]{background-color:#fff;color:#000}button.reservada[_ngcontent-%COMP%]{background-color:#e4ff49;color:#000}button[_ngcontent-%COMP%]:hover{background-color:gray}.overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100vw;height:100vh;background-color:#000000b3;display:flex;justify-content:center;align-items:center;z-index:100}.reserva-dialogo[_ngcontent-%COMP%]{background-color:var(--color-principal);padding:20px;border-radius:8px;box-shadow:0 4px 10px #00000040;text-align:center;z-index:1001}.reserva-dialogo[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:2em;margin-bottom:20px}.reserva-dialogo[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin:0 10px;padding:10px 20px;border:none;border-radius:4px;cursor:pointer}.reserva-dialogo[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:first-child{background-color:#4caf50;color:#fff}.reserva-dialogo[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:last-child{background-color:#f44336;color:#fff}.botones-cambio-semana[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;margin-bottom:20px;gap:10px}.botones-cambio-semana[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{background:#222;color:#fff;border:2px solid #444;border-radius:50%;width:40px;height:40px;font-size:1.5em;font-weight:700;transition:background .2s,color .2s,border .2s;box-shadow:0 2px 8px #0000004d;cursor:pointer;outline:none;display:flex;align-items:center;justify-content:center}.botones-cambio-semana[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:disabled{background:#444;color:#888;border-color:#333;cursor:not-allowed}.botones-cambio-semana[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover:not(:disabled){background:#fff;color:#111;border-color:#fff}@media (max-width: 600px){table[_ngcontent-%COMP%]{width:90vw}td[_ngcontent-%COMP%]{padding:2px}.botones-cambio-semana[_ngcontent-%COMP%]{gap:10px}.botones-cambio-semana[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{font-size:1.2em}h2[_ngcontent-%COMP%]{margin:.3vw 0 1vw}}"]})}}return i})();export{W as a,R as b,X as c,Z as d,Oe as e};
