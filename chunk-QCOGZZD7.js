import{a as J}from"./chunk-UIIKRNJP.js";import{a as I}from"./chunk-4XRXFSFZ.js";import{a as Y}from"./chunk-RP6ADSK5.js";import{d as P}from"./chunk-YROXT644.js";import{b as $,e as N}from"./chunk-QSU6O5O7.js";import{$a as j,Ga as m,Hb as z,I as h,Ib as L,Ka as D,Pa as F,Sa as E,U as w,Ua as x,Z as S,ab as B,cb as C,db as M,ec as U,fa as f,fb as k,ga as v,gb as O,hb as r,ib as o,lb as T,mb as b,nb as d,t as g,vb as p,wb as V,xb as R,yb as A,zb as H}from"./chunk-2QB5VWAC.js";var q=(()=>{class i{transform(e){let t=e.toLocaleString("default",{month:"long"});return t.charAt(0).toUpperCase()+t.slice(1)}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275pipe=E({name:"dateMesString",type:i,pure:!0})}}return i})();var G=(()=>{class i{constructor(e,t){this.httpService=e,this.cargandoService=t}dateAUTC(e){return new Date(e.getTime()+e.getTimezoneOffset()*60*1e3)}primerDiaSemana(e){let t=new Date(e),a=t.getDay(),n=a===0?-6:1-a;return t.setDate(t.getDate()+n),t}diaHora(e,t){let[a,n]=t.split(":").map(Number),c=new Date(e);return c.setHours(a,n,0,0),c}calcularSemana(e,t=0){let a=[];e.setUTCHours(0,0,0,0);let n=this.primerDiaSemana(this.sumarDias(e,t*7));for(let c=0;c<7;c++)a.push(this.sumarDias(n,c));return a}sumarDias(e,t){let a=new Date(e);return a.setDate(a.getDate()+t),a}generarFranjasHorarias(e){let t,a,n;if(e){let s=Object.values(e).flat();t=Math.min(...s.map(_=>parseInt(_.split(":")[0]))),a=Math.max(...s.map(_=>parseInt(_.split(":")[0]))),n=Math.max(...s.filter(_=>parseInt(_.split(":")[0])===a).map(_=>parseInt(_.split(":")[1])))}else t=0,a=23,n=30;let l=[];for(let s=t;s<a+1;s++)for(let _=0;_<60;_+=30){let Q=`${s.toString().padStart(2,"0")}:${_.toString().padStart(2,"0")}`;if(l.push(Q),s===a&&_===n)break}return l}subirCitas(e,t){let a={idBarbero:e,fechas:t};return this.httpService.postToken("/citas/crear",a)}getCitas(e,t){t=this.primerDiaSemana(t);let a=this.sumarDias(t,7),n={idBarbero:e,inicio:t,fin:a};return this.httpService.postToken("/citas",n).pipe(g(c=>["totales","reservadas","reservadasUsuario"].reduce((l,s)=>(l[s]=this.procesarFechas(c[s]),l),{})),h(()=>{this.cargandoService.ocultarCargando()}))}getCitasBarbero(e={}){return this.httpService.getToken("/citas/barbero",e)}getCitasUsuario(e={}){return this.httpService.getToken("/citas/cliente",e)}purgarDiasPasados(e,t){let a=new Date,n={};return Object.entries(e).forEach(([c,l])=>{let s=parseInt(c);s===a.getDate()?n[s]=l.filter(_=>_>`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`):(s>a.getDate()||s<a.getDate()-7)&&(n[s]=l)}),n}procesarFechas(e){let t={};return e.forEach(a=>{let n=new Date(a),c=n.getDate();t[c]||(t[c]=[]),t[c].push(`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`)}),t}confirmarReserva(e,t){let a={idBarbero:e,dia:t};return this.httpService.postToken("/citas/confirmar",a)}generarCitasSemana(e,t){return this.httpService.postToken("/citas/generar-semana",{inicio:e,fin:t})}static{this.\u0275fac=function(t){return new(t||i)(S(P),S(I))}}static{this.\u0275prov=w({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var K=(()=>{class i{constructor(e,t){this.httpService=e,this.cargandoService=t}getRelaciones(e){return this.httpService.getToken("/relaciones").pipe(g(t=>(e&&(t=JSON.parse(JSON.stringify(t)).filter(a=>a.estado===e)),t)),h(()=>this.cargandoService.ocultarCargando()))}getRelacionesCliente(){return this.httpService.getToken("/relaciones/cliente").pipe(g(e=>JSON.parse(JSON.stringify(e)).filter(t=>t.estado==="aceptado")),h(()=>this.cargandoService.ocultarCargando()))}getRelacionesBarbero(){return this.httpService.getToken("/relaciones/barbero").pipe(g(e=>JSON.parse(JSON.stringify(e)).filter(t=>t.estado==="aceptado")),h(()=>this.cargandoService.ocultarCargando()))}getSolicitudes(){return this.httpService.getToken("/relaciones/solicitudes").pipe(h(()=>this.cargandoService.ocultarCargando()))}solicitar(e){return this.httpService.postToken("/relaciones/solicitar",{userBarbero:e}).pipe(g(t=>!!t),h(()=>this.cargandoService.ocultarCargando()))}aceptarSolicitud(e){return this.httpService.postToken("/relaciones/aceptar",{idRelacion:e}).pipe(h(()=>this.cargandoService.ocultarCargando()))}rechazarSolicitud(e){return this.httpService.postToken("/relaciones/rechazar",{idRelacion:e}).pipe(h(()=>this.cargandoService.ocultarCargando()))}eliminarRelacion(e){return this.httpService.postToken("/relaciones/eliminar",{idRelacion:e}).pipe(h(()=>this.cargandoService.ocultarCargando()))}comprobarRelacion(e){return this.httpService.getToken("/relaciones/comprobar",{idBarbero:e.toString()}).pipe(h(()=>this.cargandoService.ocultarCargando()))}static{this.\u0275fac=function(t){return new(t||i)(S(P),S(I))}}static{this.\u0275prov=w({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();function te(i,u){if(i&1&&(r(0,"div",1)(1,"div",2)(2,"p"),p(3),o(),r(4,"a",3),p(5,"Volver a Inicio"),o()()()),i&2){let e=d(2);m(3),R('El usuario "',e.usernameBarbero,'" no es v\xE1lido')}}function ie(i,u){if(i&1&&(r(0,"div",1)(1,"div",2)(2,"p"),p(3),o(),r(4,"a",3),p(5,"Volver a Inicio"),o()()()),i&2){let e=d(2);m(3),R('El usuario "',e.usernameBarbero,'" no es Barbero')}}function ae(i,u){if(i&1){let e=T();r(0,"button",4),b("click",function(){f(e);let a=d(3);return v(a.solicitar(a.usernameBarbero))}),p(1,"Enviar solicitud"),o()}}function ne(i,u){i&1&&(r(0,"h3"),p(1,"Ya has enviado una solicitud, espera a que sea aceptada"),o())}function re(i,u){i&1&&(r(0,"h3"),p(1,"Tu solicitud ha sido rechazada"),o())}function oe(i,u){if(i&1&&(r(0,"div",1)(1,"div",2)(2,"p"),p(3),o(),x(4,ae,2,0,"button")(5,ne,2,0,"h3")(6,re,2,0,"h3"),r(7,"a",3),p(8,"Volver a Inicio"),o()()()),i&2){let e=d(2);m(3),R("No tienes acceso a las citas de ",e.usernameBarbero,""),m(),C(e.relacion=="ninguna"?4:e.relacion=="pendiente"?5:e.relacion=="rechazado"?6:-1)}}function se(i,u){if(i&1&&(r(0,"th"),p(1),o()),i&2){let e=u.$implicit;m(),V(e.getDate())}}function ce(i,u){if(i&1){let e=T();r(0,"td")(1,"button",6),b("click",function(){let a=f(e).$implicit,n=d().$implicit,c=d(5);return v(c.mostrarReserva(a,n))}),p(2),o()()}if(i&2){let e=u.$implicit,t=d().$implicit,a=d(5);m(),B("selected",a.esFranjaReservada(e.getDate(),t)===1&&a.esFranjaDisponible(e,t))("reservada",a.esFranjaReservada(e.getDate(),t)===2&&a.esFranjaDisponible(e,t)),j("disabled",!a.esFranjaDisponible(e,t)||a.esFranjaReservada(e.getDate(),t)),m(),R(" ",t," ")}}function le(i,u){if(i&1&&(r(0,"tr"),k(1,ce,3,6,"td",null,M),o()),i&2){let e=d(5);m(),O(e.diasDeLaSemana)}}function de(i,u){if(i&1&&(r(0,"tbody"),k(1,le,3,0,"tr",null,M),o()),i&2){let e=d(4);m(),O(e.franjasHorarias)}}function pe(i,u){i&1&&(r(0,"tr")(1,"td",7),p(2,"No hay horarios disponibles esta semana"),o()())}function me(i,u){if(i&1&&(r(0,"table")(1,"thead")(2,"tr"),k(3,se,2,1,"th",null,M),o()(),x(5,de,3,0,"tbody")(6,pe,3,0,"tr"),o()),i&2){let e=d(3);m(3),O(e.diasDeLaSemana),m(2),C(e.franjasHorarias.length>0?5:6)}}function ue(i,u){if(i&1){let e=T();r(0,"p"),p(1),o(),r(2,"button",4),b("click",function(){f(e);let a=d(4);return v(a.confirmarReserva())}),p(3,"Confirmar"),o()}if(i&2){let e=d(4);m(),H("Reservar el ",e.diaSeleccionado.getDate()," a las ",e.diaSeleccionado.getHours(),":",e.diaSeleccionado.getMinutes()===0?"00":e.diaSeleccionado.getMinutes(),"")}}function _e(i,u){i&1&&(r(0,"p"),p(1,"No puedes reservarte cita a ti mismo"),o())}function he(i,u){if(i&1){let e=T();r(0,"div",1)(1,"div",2),x(2,ue,4,3)(3,_e,2,0,"p"),r(4,"button",4),b("click",function(){f(e);let a=d(3);return v(a.cancelarReserva())}),p(5,"Cancelar"),o()()()}if(i&2){let e=d(3);m(2),C(e.idBarbero!=e.idUsuario?2:3)}}function Ce(i,u){if(i&1){let e=T();r(0,"h2"),p(1),z(2,"dateMesString"),o(),r(3,"div",5)(4,"button",6),b("click",function(){f(e);let a=d(2);return v(a.cambiarSemana(-1))}),p(5,"-"),o(),r(6,"button",4),b("click",function(){f(e);let a=d(2);return v(a.cambiarSemana(1))}),p(7,"+"),o()(),x(8,me,7,1,"table")(9,he,6,1,"div",1)}if(i&2){let e=d(2);m(),A("",L(2,5,e.semanaActual.fin)," ",e.semanaActual.fin.getFullYear(),""),m(3),j("disabled",e.desactivarAtras()),m(4),C(e.cargandoLocal?-1:8),m(),C(e.mostrarDialogo?9:-1)}}function ge(i,u){if(i&1&&x(0,te,6,1,"div",1)(1,ie,6,1,"div",1)(2,oe,9,2,"div",1)(3,Ce,10,7),i&2){let e=d();C(e.usernameValido?e.esBarbero?e.usuarioAutorizado?e.usernameValido?3:-1:2:1:0)}}var Me=(()=>{class i{constructor(e,t,a,n,c){this.citasService=e,this.usuariosService=t,this.relacionesService=a,this.route=n,this.toastService=c,this.usernameValido=!1,this.usuarioAutorizado=!1,this.relacion="",this.diasDeLaSemana=[],this.franjasHorarias=[],this.idUsuario=parseInt(JSON.parse(localStorage.getItem("user")||"{}").id||"0",10),this.idBarbero=0,this.usernameBarbero="",this.esBarbero=!0,this.horariosDisponibles=[],this.horariosReservados=[],this.horariosReservadosPorUsuario=[],this.mostrarDialogo=!1,this.diaSeleccionado=new Date,this.cargandoLocal=!0,this.cargandoCitas=!0,this.semanaActual={inicio:new Date,fin:new Date}}ngOnInit(){this.route.params.subscribe({next:e=>{this.usernameBarbero=e.username,this.usuariosService.datosUsername(this.usernameBarbero).subscribe({next:t=>{this.usernameValido=t.exists,t.exists&&t.user?.id&&(this.idBarbero=t.user?.id),this.usernameValido&&(this.idBarbero==this.idUsuario?(this.usuarioAutorizado=!0,this.esBarbero=!0,this.calcularSemana(),this.relacion="aceptado",this.cargandoLocal=!1):this.relacionesService.comprobarRelacion(this.idBarbero).subscribe({next:a=>{this.usuarioAutorizado=a.relacion=="aceptado",this.relacion=a.relacion,this.usuariosService.esBarbero(this.idBarbero).subscribe({next:n=>{this.esBarbero=n,this.usuarioAutorizado&&this.esBarbero&&(this.calcularSemana(),this.cargandoLocal=!1)}})}}))}})}})}desactivarAtras(){return this.semanaActual.inicio.getTime()<=this.citasService.dateAUTC(new Date).getTime()}calcularSemana(e=0){this.cargandoCitas=!0,this.diasDeLaSemana=this.citasService.calcularSemana(this.semanaActual.inicio,e),this.semanaActual.inicio=this.diasDeLaSemana[0],this.semanaActual.fin=this.diasDeLaSemana[6],this.recargarCitas(),this.cargandoCitas=!1}cambiarSemana(e){this.calcularSemana(e)}getStringMes(e){return new Date(2025,e-1).toLocaleString("default",{month:"long"})}recargarCitas(){this.citasService.getCitas(this.idBarbero,this.semanaActual.inicio).subscribe({next:e=>{this.horariosReservados=e.reservadas,this.horariosDisponibles=this.citasService.purgarDiasPasados(e.totales,this.semanaActual.inicio),this.horariosReservadosPorUsuario=e.reservadasUsuario,this.generarFranjasHorarias()}})}generarFranjasHorarias(){let e=Object.values(this.horariosDisponibles).flat(),t=Math.min(...e.map(l=>parseInt(l.split(":")[0]))),a=Math.max(...e.map(l=>parseInt(l.split(":")[0]))),n=Math.max(...e.filter(l=>parseInt(l.split(":")[0])===a).map(l=>parseInt(l.split(":")[1]))),c=30;this.franjasHorarias=[];for(let l=t;l<a+1;l++)for(let s=0;s<60;s+=c){let _=`${l.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;if(this.franjasHorarias.push(_),l===a&&s===n)break}}esFranjaDisponible(e,t){return this.citasService.diaHora(e,t).getTime()<new Date().getTime()?!1:this.horariosDisponibles[e.getDate()]?.includes(t)||!1}esFranjaReservada(e,t){return this.horariosReservadosPorUsuario[e]?.includes(t)?2:this.horariosReservados[e]?.includes(t)?1:0}mostrarReserva(e,t){this.diaSeleccionado=this.citasService.diaHora(e,t),this.mostrarDialogo=!0}confirmarReserva(){this.citasService.confirmarReserva(this.idBarbero,this.diaSeleccionado).subscribe({next:()=>{this.mostrarDialogo=!1,this.recargarCitas()},error:e=>{this.toastService.error(e)}})}cancelarReserva(){this.mostrarDialogo=!1}solicitar(e){this.relacionesService.solicitar(e),this.relacion="pendiente"}static{this.\u0275fac=function(t){return new(t||i)(D(G),D(J),D(K),D($),D(Y))}}static{this.\u0275cmp=F({type:i,selectors:[["app-reservar-citas"]],decls:2,vars:1,consts:[[1,"component-container"],[1,"overlay"],[1,"reserva-dialogo"],["routerLink","/"],[3,"click"],[1,"botones-cambio-semana"],[3,"click","disabled"],["colspan","7"]],template:function(t,a){t&1&&(r(0,"div",0),x(1,ge,4,1),o()),t&2&&(m(),C(a.cargandoLocal?-1:1))},dependencies:[q,U,N],styles:["h2[_ngcontent-%COMP%]{font-size:2vw}table[_ngcontent-%COMP%]{width:50vw;border-collapse:collapse;text-align:center;table-layout:fixed}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:10px;border:1px solid #ddd}button[_ngcontent-%COMP%]{width:100%;padding:5px;border:none;cursor:pointer}button.selected[_ngcontent-%COMP%]{background-color:#fff;color:#000}button.reservada[_ngcontent-%COMP%]{background-color:#e4ff49;color:#000}button[_ngcontent-%COMP%]:hover{background-color:gray}.overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100vw;height:100vh;background-color:#000000b3;display:flex;justify-content:center;align-items:center;z-index:100}.reserva-dialogo[_ngcontent-%COMP%]{background-color:var(--color-principal);padding:20px;border-radius:8px;box-shadow:0 4px 10px #00000040;text-align:center;z-index:1001}.reserva-dialogo[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:2em;margin-bottom:20px}.reserva-dialogo[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin:0 10px;padding:10px 20px;border:none;border-radius:4px;cursor:pointer}.reserva-dialogo[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:first-child{background-color:#4caf50;color:#fff}.reserva-dialogo[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:last-child{background-color:#f44336;color:#fff}.botones-cambio-semana[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;margin-bottom:20px;gap:10px}.botones-cambio-semana[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{background:#222;color:#fff;border:2px solid #444;border-radius:50%;width:40px;height:40px;font-size:1.5em;font-weight:700;transition:background .2s,color .2s,border .2s;box-shadow:0 2px 8px #0000004d;cursor:pointer;outline:none;display:flex;align-items:center;justify-content:center}.botones-cambio-semana[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:disabled{background:#444;color:#888;border-color:#333;cursor:not-allowed}.botones-cambio-semana[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover:not(:disabled){background:#fff;color:#111;border-color:#fff}@media (max-width: 600px){table[_ngcontent-%COMP%]{width:90vw}td[_ngcontent-%COMP%]{padding:2px}.botones-cambio-semana[_ngcontent-%COMP%]{gap:10px}.botones-cambio-semana[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{font-size:1.2em}h2[_ngcontent-%COMP%]{margin:.3vw 0 1vw}}"]})}}return i})();export{q as a,G as b,K as c,Me as d};
